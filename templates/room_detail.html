{% extends "base.html" %}

{% block title %}{{ room.name }} - Gancheng B&B{% endblock %}

{% block content %}
    <!-- Room Hero Section -->
    <section class="w-full px-4 md:px-10 py-12 md:py-20">
        <div class="max-w-[1280px] mx-auto">
            <div class="grid md:grid-cols-2 gap-8 items-start">
                <!-- Room Image -->
                <div class="rounded-2xl overflow-hidden shadow-xl aspect-[4/3] bg-slate-200"
                     style='background-image: linear-gradient(rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%), url("{{ room.image_url }}")'
                     data-alt="{{ room.name }} interior">
                    <div class="w-full h-full bg-cover bg-center"></div>
                </div>

                <!-- Room Info -->
                <div class="flex flex-col gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h1 class="text-4xl font-bold text-slate-900 dark:text-white">{{ room.name }}</h1>
                            <span class="px-3 py-1 text-xs font-bold rounded-full
                                {% if room.is_available %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if room.is_available %}AVAILABLE{% else %}UNAVAILABLE{% endif %}
                            </span>
                        </div>
                        <p class="text-lg text-slate-500 dark:text-slate-400">{{ room.room_type }}</p>
                    </div>

                    <div class="flex items-baseline gap-2">
                        <span class="text-4xl font-bold text-primary">NT$ {{ "{:,.0f}".format(room.price_per_night) }}</span>
                        <span class="text-slate-500">per night</span>
                    </div>

                    <p class="text-lg text-slate-600 dark:text-slate-300 leading-relaxed">{{ room.description }}</p>

                    <!-- Room Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                            <span class="material-symbols-outlined text-primary text-3xl">group</span>
                            <div>
                                <p class="text-sm text-slate-500">Max Guests</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white">{{ room.max_guests }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                            <span class="material-symbols-outlined text-primary text-3xl">bed</span>
                            <div>
                                <p class="text-sm text-slate-500">Room Type</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white">{{ room.room_type }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Amenities -->
                    {% if room.amenities %}
                    <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Amenities</h3>
                        <div class="grid grid-cols-2 gap-3">
                            {% for amenity in room.amenities.split(',') %}
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-green-600 text-xl">check_circle</span>
                                <span class="text-slate-700 dark:text-slate-300">{{ amenity.strip() }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Booking Form -->
                    <div class="p-6 bg-gradient-to-br from-primary/5 to-blue-50 dark:from-primary/10 dark:to-gray-800 rounded-xl border-2 border-primary/20">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Book This Room</h3>
                        
                        <div id="booking-message" class="hidden mb-4 p-3 rounded-lg"></div>
                        
                        <form id="booking-form" class="space-y-4">
                            <input type="hidden" name="room_id" value="{{ room.id }}">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Check-in</label>
                                    <input type="date" name="check_in" required 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                                           min="{{ today }}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Check-out</label>
                                    <input type="date" name="check_out" required 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                                           min="{{ today }}">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Number of Guests</label>
                                <input type="number" name="num_guests" required min="1" max="{{ room.max_guests }}" value="1"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                                <p class="text-xs text-slate-500 mt-1">Maximum {{ room.max_guests }} guests</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Your Name</label>
                                <input type="text" name="guest_name" required 
                                       {% if current_user.is_authenticated %}value="{{ current_user.username }}"{% endif %}
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Address</label>
                                <input type="email" name="guest_email" required 
                                       {% if current_user.is_authenticated %}value="{{ current_user.email }}"{% endif %}
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Phone (Optional)</label>
                                <input type="tel" name="guest_phone" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div id="price-preview" class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hidden">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-slate-600 dark:text-slate-400">Price per night</span>
                                    <span class="font-medium text-slate-900 dark:text-white">NT$ {{ "{:,.0f}".format(room.price_per_night) }}</span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-slate-600 dark:text-slate-400"><span id="nights-count">0</span> nights</span>
                                    <span class="font-medium text-slate-900 dark:text-white" id="nights-price">NT$ 0</span>
                                </div>
                                <div class="border-t border-gray-200 dark:border-gray-600 pt-2 mt-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-slate-900 dark:text-white">Total</span>
                                        <span class="font-bold text-primary text-xl" id="total-price">NT$ 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" id="submit-btn"
                                    class="w-full flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-sm font-bold shadow-lg shadow-primary/20 hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="truncate">Confirm Booking</span>
                            </button>
                        </form>
                        
                        <a href="{{ url_for('index') }}#rooms" class="block mt-3 text-center text-sm text-slate-600 dark:text-slate-400 hover:text-primary">
                            View All Rooms
                        </a>
                    </div>
                </div>
            </div>

            <!-- Additional Info -->
            <div class="mt-12 p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">About This Room</h3>
                <div class="prose dark:prose-invert max-w-none">
                    <p class="text-slate-600 dark:text-slate-300">
                        Experience the perfect blend of comfort and tranquility in our {{ room.name }}. 
                        Located in the heart of Hualien, this room offers stunning views and premium amenities 
                        to make your stay unforgettable. Whether you're here for relaxation or adventure, 
                        our accommodation provides the ideal base for exploring the natural beauty of Taiwan's east coast.
                    </p>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script>
        const roomPrice = {{ room.price_per_night }};
        const checkInInput = document.querySelector('input[name="check_in"]');
        const checkOutInput = document.querySelector('input[name="check_out"]');
        const pricePreview = document.getElementById('price-preview');
        const nightsCount = document.getElementById('nights-count');
        const nightsPrice = document.getElementById('nights-price');
        const totalPrice = document.getElementById('total-price');
        const bookingForm = document.getElementById('booking-form');
        const bookingMessage = document.getElementById('booking-message');
        const submitBtn = document.getElementById('submit-btn');

        // Calculate and display price
        function updatePrice() {
            const checkIn = new Date(checkInInput.value);
            const checkOut = new Date(checkOutInput.value);
            
            if (checkInInput.value && checkOutInput.value && checkOut > checkIn) {
                const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                const total = nights * roomPrice;
                
                nightsCount.textContent = nights;
                nightsPrice.textContent = 'NT$ ' + total.toLocaleString('en-US');
                totalPrice.textContent = 'NT$ ' + total.toLocaleString('en-US');
                pricePreview.classList.remove('hidden');
            } else {
                pricePreview.classList.add('hidden');
            }
        }

        checkInInput.addEventListener('change', updatePrice);
        checkOutInput.addEventListener('change', updatePrice);

        // Handle form submission
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="truncate">Processing...</span>';
            
            const formData = new FormData(bookingForm);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    bookingMessage.className = 'mb-4 p-3 rounded-lg bg-green-50 text-green-800 border border-green-200';
                    bookingMessage.textContent = '✓ Booking confirmed! Total: NT$ ' + result.total_price.toLocaleString('en-US') + '. Check your email for details.';
                    bookingMessage.classList.remove('hidden');
                    bookingForm.reset();
                    pricePreview.classList.add('hidden');
                    
                    // Redirect to profile after 2 seconds if logged in
                    {% if current_user.is_authenticated %}
                    setTimeout(() => {
                        window.location.href = '{{ url_for("profile") }}';
                    }, 2000);
                    {% endif %}
                } else {
                    bookingMessage.className = 'mb-4 p-3 rounded-lg bg-red-50 text-red-800 border border-red-200';
                    bookingMessage.textContent = '✗ ' + (result.error || 'Booking failed. Please try again.');
                    bookingMessage.classList.remove('hidden');
                }
            } catch (error) {
                bookingMessage.className = 'mb-4 p-3 rounded-lg bg-red-50 text-red-800 border border-red-200';
                bookingMessage.textContent = '✗ An error occurred. Please try again.';
                bookingMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="truncate">Confirm Booking</span>';
            }
        });
    </script>
{% endblock %}
